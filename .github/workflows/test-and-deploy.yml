name: ğŸ”¥ Test and Deploy - Validate or Die

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: ğŸ§ª Run Tests
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: ğŸ“š Install dependencies
      run: npm install

    - name: ğŸŒ Install Playwright browsers
      run: npx playwright install --with-deps

    - name: ğŸ§ª Run Playwright tests
      run: npx playwright test

    - name: ğŸ“Š Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 30

    - name: ğŸ“‹ Upload test screenshots
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: test-screenshots
        path: test-results/
        retention-days: 7

  deploy:
    name: ğŸš€ Deploy to Production
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: âœ… Tests passed - Ready for deployment
      run: |
        echo "ğŸ”¥ All tests passed! Landing page is bulletproof."
        echo "ğŸš€ Deployment would happen here (GitHub Pages, Netlify, etc.)"
        echo "ğŸ“Š Test report: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

    # Uncomment below for actual GitHub Pages deployment
    # - name: ğŸŒ Deploy to GitHub Pages
    #   uses: peaceiris/actions-gh-pages@v3
    #   with:
    #     github_token: ${{ secrets.GITHUB_TOKEN }}
    #     publish_dir: ./
    #     exclude_assets: 'tests/**,node_modules/**,package*.json,playwright.config.js,jest.config.js'

  notify:
    name: ğŸ“¢ Notify Results
    runs-on: ubuntu-latest
    needs: [test, deploy]
    if: always()

    steps:
    - name: ğŸ“¢ Success notification
      if: needs.test.result == 'success'
      run: |
        echo "âœ… SUCCESS: All tests passed!"
        echo "ğŸ”¥ Your brutal landing page is still brutal and functional!"

    - name: ğŸ“¢ Failure notification
      if: needs.test.result == 'failure'
      run: |
        echo "âŒ FAILURE: Tests failed!"
        echo "ğŸ›‘ Deployment blocked - fix the issues before proceeding."
        echo "ğŸ“Š Check test results: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        exit 1